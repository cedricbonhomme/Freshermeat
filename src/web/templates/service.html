{% extends "layout.html" %}
{% block content %}
<div class="container">
    <div class="alert alert-success alert-dismissible" role="alert" id="alert-box">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        <strong>Success</strong> Request sent!
    </div>
    <div class="row">
        <div class="col">
            <h1>Our services</h1>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">SECURITYMADEIN.LU</a></li>
                <li class="breadcrumb-item"><a href="/" id="organization-name">Organization</a></li>
                <li class="breadcrumb-item active" id="service-name">Library</li>
            </ol>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <img id="service-logo" src="" width="300px"/>
        </div>
    </div>
    <div class="row">
        <div class="col">
            Website:&nbsp;<a id="service-website"></a>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div><p id="service-description" class="lead"></p></div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <h4>Interested by this service?</h4>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <p>Please, prodive us the following information and we will get back to you.</p>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <form id="required-informations">
                <div class="form-group">
                    <input type="email" class="form-control" required-information="email" placeholder="Email" id="form-email" required="true">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" required-information="firstname" placeholder="Firstname" id="form-firstname" required="true">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" required-information="lastname" placeholder="Lastname" id="form-lastname" required="true">
                </div>
                <input type="hidden" id="service-id-input" name="service-id-input" required-information="service_id" value="" id="form-email">
            </form>
        </div>
    </div>
</div><!-- /.container -->

<script>
$("#alert-box").hide();
$(document).ready(function() {
    // Get information about the service in the URL parameter
    var service = getUrlParameter('name');
    var filters = [{"name": "name", "op": "like", "val": service}];
    $.ajax({
        url: "{{ url_for('serviceapi0.serviceapi',) }}",
        data: {"q": JSON.stringify({"filters": filters})},
        dataType: "json",
        contentType: "application/json",
        success: function(data) {
            $("#organization-name").html(data.objects[0].organization);
            $("#organization-name").attr("href", '/?organization=' +
                                                data.objects[0].organization);
            $("#service-name").html(data.objects[0].name);
            $("#service-logo").attr("src", data.objects[0].logo);
            $("#service-website").html(data.objects[0].website);
            $("#service-website").attr("href", data.objects[0].website);
            $("#service-description").html(data.objects[0].description);
            $("#service-id-input").val(data.objects[0].id);

            data.objects[0].required_informations
            .sort(function (a, b) {
                return a.order - b.order ;
            })
            .map(function (required_information) {
                $('#required-informations')
                .append('<div class="form-group">'
                        + '<input type="' + required_information.type + '" class="form-control service-specific" required-information="'
                        + required_information.name + '" placeholder="'
                        + required_information.name + '" ' + (required_information.required ? ' required' : '') + '></div>');
            });
            $('#required-informations')
            .append('<button type="submit" id="submitButton" class="btn btn-primary">Submit</button>');
        }
    });
});

$("#required-informations").submit(function(event) {
    event.preventDefault();

    var requests_informations = {};
    var service_required_informations = {};
    $('form#required-informations :input').each(function() {
        if (! $(this).is( ":button" )) {
            if ($(this).hasClass('service-specific')) {
                if ($(this).attr('type') == 'file') {
                    console.log($(this)[0].files[0]);
                    service_required_informations[$(this).attr('required-information')] = $(this)[0].files[1];
                } else {
                    service_required_informations[$(this).attr('required-information')] = $(this).val();
                }
            } else {
                requests_informations[$(this).attr('required-information')] = $(this).val();
            }
        }
    });
    requests_informations['required_informations'] = service_required_informations;

    $.ajax({
        url: "{{ url_for('requestapi0.requestapi') }}",
        type: 'POST',
        dataType: 'json',
        contentType: "application/json",
        data: JSON.stringify(requests_informations),
        headers: {
            contentType: "application/json"
        },
        success: function(result) {
            // console.log(result);
            $("#alert-box").show();
        }
    });
});
</script>
{% endblock %}
